{% extends "base.html" %}

{% block title %}{{ username }}'s Open Source Report Card{% endblock %}

{% block body %}

<div class="profile-badge clearfix">
    <a href="https://github.com/{{ username }}" target="_blank">
    <img height="50" width="50" alt="{{ username }}" class="avatar" src="https://secure.gravatar.com/avatar/{{ gravatar }}?s=220&d=https://a248.e.akamai.net/assets.github.com%2Fimages%2Fgravatars%2Fgravatar-user-420.png">
    <span class="profile-name">{{ name }}</span>
    </a>
</div>
<div id="description">
</div>

<script type="text/html" id="description-template">
    <%= summary %>
</script>

<h1>Statistics</h1>

<div class="hist-block">
    <div id="week" class="hist"></div>
    <div id="day" class="hist"></div>
</div>

{% endblock %}

{% block scripts %}

<script src="{{ url_for(".static", filename="d3.v3.min.js") }}"></script>
<script src="{{ url_for(".static", filename="underscore-min.js") }}"></script>
<script src="{{ url_for(".static", filename="jquery-1.9.1.min.js") }}"></script>
<script src="{{ url_for(".static", filename="plot.js") }}"></script>
<script>

function fill_comps () {
    $(".comparison").each(function (d) {
        var this_ = $(this);
        $.ajax({
            url: this_.data("url"),
            success: function (comp) {
                this_.text(comp);
            }
        });
    });
}

d3.json("{{ url_for(".get_stats", username=username) }}?firstname={{ firstname }}", function (data) {

    // Display description.
    var template = _.template($("#description-template").html());
    $("#description").html(template(data));

    var week_hist = window.histogram().width(200)
                                      .labels(["S","M","T","W","T","F","S"]);
    d3.select("#week").datum(data.week).call(week_hist);

    // Wrap the day histogram.
    var day = [];
    for (var i = 0; i < 24; ++i)
        day[i] = data.day[(i + 1) % 24];

    var day_hist = window.histogram().width(400)
                .labels(["", "3am","","","6am","","","9am","","","noon",
                         "","","3pm","","","6pm","","","9pm","","","12am",""]);
    d3.select("#day").datum(day).call(day_hist);

    // Legend.
    var cb = d3.scale.category10();
    var sel = d3.select("#hist-legend").selectAll("span").data(data.events);
    sel.enter().append("span");
    sel.text(function (d) { return d; })
       .style("color", function (d, i) { return cb(i); });
    sel.exit().remove();

    fill_comps();

});

</script>

{% endblock %}
